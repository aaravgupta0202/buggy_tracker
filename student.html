<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buggy Tracker - Student üõ∫</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .buggy-count {
            background: #e8f5e9;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #2e7d32;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        /* Center button */
        #centerBtn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        }
        
        /* Stale buggy warning */
        .stale-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üõ∫ Buggy Tracker - Student</h1>
            <p>View all active buggies in real-time on campus</p>
        </header>

        <main>
            <div class="card">
                <div class="text-center mb-2">
                    <div id="buggyCount" class="buggy-count">
                        Active Buggies: <span id="activeCount">0</span>
                    </div>
                </div>

                <div id="staleWarning" class="stale-warning">
                    Some buggies may be stale (last update > 30 seconds ago)
                </div>

                <div id="map"></div>
                
                <div class="text-center mt-2">
                    <button id="centerBtn" class="btn">üìç Center on My Location</button>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Buggy Tracker System | Real-time campus transportation</p>
        </footer>
    </div>

    <!-- Floating Help Button -->
    <button class="help-btn" id="helpBtn">?</button>

    <!-- Instructions Modal -->
    <div class="instructions-modal" id="instructionsModal">
        <div class="instructions-content">
            <button class="close-btn" id="closeModal">&times;</button>
            <h3>Student Instructions</h3>
            <ul>
                <li><strong>Your Location:</strong> The blue marker shows your current location on campus.</li>
                <li><strong>Buggy Icons:</strong> Each üõ∫ icon represents an active buggy.</li>
                <li><strong>Real-time Tracking:</strong> Buggy positions update automatically every 5 seconds.</li>
                <li><strong>Click Buggies:</strong> Click on any buggy icon to see its name and focus the map on it.</li>
                <li><strong>Center Map:</strong> Use the "Center on My Location" button to return to your position.</li>
                <li><strong>Live Movement:</strong> Watch buggies move in real-time as drivers travel across campus.</li>
                <li><strong>Zoom Controls:</strong> Use +/- buttons or mouse wheel to zoom in/out on the map.</li>
                <li><strong>Full Screen:</strong> The map automatically centers on your location when you first open the page.</li>
                <li><strong>Stale Buggies:</strong> If a buggy hasn't updated in 30+ seconds, it may no longer be active.</li>
            </ul>
            <p><strong>Tip:</strong> Keep this page open to monitor buggy availability in real-time!</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <!-- Leaflet.js -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Firebase Configuration - MUST MATCH DRIVER CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const buggyCountSpan = document.getElementById('activeCount');
        const centerBtn = document.getElementById('centerBtn');
        const helpBtn = document.getElementById('helpBtn');
        const instructionsModal = document.getElementById('instructionsModal');
        const closeModal = document.getElementById('closeModal');
        const staleWarning = document.getElementById('staleWarning');

        // State variables
        let map = null;
        let studentMarker = null;
        let buggyMarkers = {};
        let studentLatLng = null;
        let studentWatchId = null;
        let lastCleanupTime = Date.now();

        // Initialize map
        function initMap(lat, lng) {
            if (!map) {
                map = L.map('map').setView([lat, lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // Add student marker
                studentMarker = L.marker([lat, lng], {
                    icon: L.icon({
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    })
                }).addTo(map);
                studentMarker.bindPopup("<b>Your Location</b>").openPopup();
            } else {
                studentMarker.setLatLng([lat, lng]);
                map.setView([lat, lng], map.getZoom());
            }
        }

        // Create buggy icon
        function createBuggyIcon() {
            return L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/2258/2258965.png',
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }

        // Update or create buggy marker
        function updateBuggyMarker(buggyId, data) {
            const lat = data.lat;
            const lng = data.lng;
            const timestamp = data.timestamp || Date.now();
            const name = data.name || `Buggy ${buggyId.replace('driver_', '').substr(0, 3)}`;
            
            // Check if buggy is stale (more than 30 seconds old)
            const isStale = Date.now() - timestamp > 30000;
            
            if (buggyMarkers[buggyId]) {
                // Update existing marker
                buggyMarkers[buggyId].setLatLng([lat, lng]);
                const popupContent = isStale 
                    ? `<b>${name} (Stale)</b><br>Last update: ${new Date(timestamp).toLocaleTimeString()}`
                    : `<b>${name}</b><br>Updated: ${new Date(timestamp).toLocaleTimeString()}`;
                buggyMarkers[buggyId].setPopupContent(popupContent);
                
                // Update marker style if stale
                if (isStale) {
                    buggyMarkers[buggyId].setOpacity(0.6);
                } else {
                    buggyMarkers[buggyId].setOpacity(1);
                }
            } else {
                // Create new marker
                buggyMarkers[buggyId] = L.marker([lat, lng], {
                    icon: createBuggyIcon(),
                    opacity: isStale ? 0.6 : 1
                }).addTo(map);
                
                const popupContent = isStale 
                    ? `<b>${name} (Stale)</b><br>Last update: ${new Date(timestamp).toLocaleTimeString()}`
                    : `<b>${name}</b><br>Updated: ${new Date(timestamp).toLocaleTimeString()}`;
                
                buggyMarkers[buggyId].bindPopup(popupContent);
                
                // Fly to buggy on click and show "Buggy X" name
                buggyMarkers[buggyId].on('click', function() {
                    map.flyTo([lat, lng], 17);
                    // Show popup with buggy name
                    this.openPopup();
                });
            }
            
            // Check if we need to show stale warning
            checkForStaleBuggies();
        }

        // Check for stale buggies
        function checkForStaleBuggies() {
            const now = Date.now();
            let hasStaleBuggies = false;
            
            Object.keys(buggyMarkers).forEach(buggyId => {
                // We can't check timestamp without storing it, so we'll rely on marker opacity
                if (buggyMarkers[buggyId].options.opacity < 1) {
                    hasStaleBuggies = true;
                }
            });
            
            staleWarning.style.display = hasStaleBuggies ? 'block' : 'none';
        }

        // Remove buggy marker
        function removeBuggyMarker(buggyId) {
            if (buggyMarkers[buggyId]) {
                map.removeLayer(buggyMarkers[buggyId]);
                delete buggyMarkers[buggyId];
            }
        }

        // Clean up stale buggies (remove buggies older than 60 seconds)
        function cleanupStaleBuggies(buggies) {
            const now = Date.now();
            const staleThreshold = 60000; // 60 seconds
            
            Object.keys(buggies).forEach(buggyId => {
                const buggy = buggies[buggyId];
                if (now - buggy.timestamp > staleThreshold) {
                    // This buggy is stale - remove it
                    removeBuggyMarker(buggyId);
                    // Note: We can't delete from Firebase here (read-only on student side)
                }
            });
        }

        // Update buggy count display
        function updateBuggyCount(buggies) {
            const activeBuggies = Object.keys(buggies || {}).length;
            buggyCountSpan.textContent = activeBuggies;
        }

        // Listen for buggy updates from Firebase
        function startBuggyTracking() {
            database.ref('buggies').on('value', (snapshot) => {
                const buggies = snapshot.val() || {};
                
                // Clean up stale buggies every 30 seconds
                if (Date.now() - lastCleanupTime > 30000) {
                    cleanupStaleBuggies(buggies);
                    lastCleanupTime = Date.now();
                }
                
                // Update buggy markers
                Object.keys(buggies).forEach(buggyId => {
                    updateBuggyMarker(buggyId, buggies[buggyId]);
                });
                
                // Remove markers for buggies that are no longer in Firebase
                Object.keys(buggyMarkers).forEach(buggyId => {
                    if (!buggies[buggyId]) {
                        removeBuggyMarker(buggyId);
                    }
                });
                
                // Update count display
                updateBuggyCount(buggies);
            });
        }

        // Get student's location
        function getStudentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    studentLatLng = [lat, lng];
                    
                    // Initialize or update map
                    initMap(lat, lng);
                    
                    // Start buggy tracking after we have student location
                    startBuggyTracking();
                },
                (error) => {
                    let message = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Please enable location permissions to use this feature.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            message = 'Location request timed out.';
                            break;
                        default:
                            message = 'An unknown error occurred.';
                            break;
                    }
                    alert('Error: ' + message + ' Using default location.');
                    
                    // Use default location (campus center)
                    studentLatLng = [40.7128, -74.0060]; // Default to NYC
                    initMap(studentLatLng[0], studentLatLng[1]);
                    startBuggyTracking();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
            
            // Watch for location changes
            studentWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    studentLatLng = [lat, lng];
                    
                    if (studentMarker) {
                        studentMarker.setLatLng([lat, lng]);
                    }
                },
                null,
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000
                }
            );
        }

        // Modal functions
        function openInstructions() {
            instructionsModal.style.display = 'flex';
        }

        function closeInstructions() {
            instructionsModal.style.display = 'none';
        }

        // Event Listeners
        centerBtn.addEventListener('click', () => {
            if (studentLatLng && map) {
                map.flyTo(studentLatLng, 16);
                studentMarker.openPopup();
            }
        });

        helpBtn.addEventListener('click', openInstructions);
        closeModal.addEventListener('click', closeInstructions);

        // Close modal when clicking outside
        instructionsModal.addEventListener('click', (e) => {
            if (e.target === instructionsModal) {
                closeInstructions();
            }
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', getStudentLocation);

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (studentWatchId) {
                navigator.geolocation.clearWatch(studentWatchId);
            }
            database.ref('buggies').off();
        });
    </script>
</body>
</html>