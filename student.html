<!DOCTYPE html>
<html>
<head>
  <title>Buggy Tracker</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head>
<body>

<header>ðŸ›º Live Buggy Map</header>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="firebase.js"></script>

<script>
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  .addTo(map);

// Student location
navigator.geolocation.getCurrentPosition(
  pos => {
    const me = [pos.coords.latitude, pos.coords.longitude];
    map.setView(me, 17);

    L.circleMarker(me, { radius: 8, color: "blue" })
      .addTo(map)
      .bindPopup("You are here")
      .openPopup();
  },
  () => map.setView([0,0], 2),
  { enableHighAccuracy: true }
);

// Buggy icon
const buggyIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/854/854894.png",
  iconSize: [40, 40],
  iconAnchor: [20, 20]
});

const markers = {};

database.ref("buggies").on("value", snapshot => {
  const data = snapshot.val();
  if (!data) return;

  Object.keys(data).forEach(id => {
    const { lat, lng } = data[id];
    if (!lat || !lng) return;

    if (!markers[id]) {
      markers[id] = L.marker([lat, lng], { icon: buggyIcon })
        .addTo(map)
        .bindPopup("ðŸ›º " + id);
    } else {
      markers[id].setLatLng([lat, lng]);
    }
  });
});
</script>

</body>
</html>
