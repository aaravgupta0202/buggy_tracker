<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buggy Tracker - Driver üõ∫</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #previewMap {
            height: 300px;
            width: 100%;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .coordinates {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin: 15px 0;
        }
        
        .last-update {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üõ∫ Buggy Tracker - Driver</h1>
            <p>Share your live location with students on campus</p>
        </header>

        <main>
            <div class="card">
                <div class="driver-info">
                    <div class="driver-id">
                        Driver ID: <span id="driverId">Generating...</span>
                    </div>
                    <div id="status" class="status status-inactive">Status: Not Tracking</div>
                </div>

                <div class="text-center">
                    <button id="startBtn" class="btn btn-start">‚ñ∂ Start Driving</button>
                    <button id="stopBtn" class="btn btn-stop" disabled>‚èπ Stop Driving</button>
                </div>

                <div id="locationInfo" style="display: none;">
                    <div class="coordinates">
                        <strong>Current Location:</strong><br>
                        Latitude: <span id="currentLat">-</span><br>
                        Longitude: <span id="currentLng">-</span>
                    </div>
                    
                    <div id="previewMap"></div>
                    <div class="last-update" id="lastUpdate">Last updated: Never</div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Buggy Tracker System | Keep this page open while driving</p>
        </footer>
    </div>

    <!-- Floating Help Button -->
    <button class="help-btn" id="helpBtn">?</button>

    <!-- Instructions Modal -->
    <div class="instructions-modal" id="instructionsModal">
        <div class="instructions-content">
            <button class="close-btn" id="closeModal">&times;</button>
            <h3>Driver Instructions</h3>
            <ul>
                <li><strong>Start Driving:</strong> Click the "Start Driving" button to begin sharing your location with students.</li>
                <li><strong>Location Permission:</strong> Allow location access when your browser asks for permission.</li>
                <li><strong>Keep Page Open:</strong> Keep this browser tab open while driving to continue sharing your location.</li>
                <li><strong>Automatic Updates:</strong> Your location updates automatically every 5 seconds.</li>
                <li><strong>Stop Tracking:</strong> Click "Stop Driving" when you're done, or close the page to automatically stop.</li>
                <li><strong>Preview Map:</strong> See your own location on the preview map below the controls.</li>
                <li><strong>Driver ID:</strong> Your unique ID is shown at the top. Students will see your buggy with this ID.</li>
            </ul>
            <p><strong>Note:</strong> This is a demo system. In production, proper authentication would be required.</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <!-- Leaflet.js -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');
        const driverIdSpan = document.getElementById('driverId');
        const locationInfoDiv = document.getElementById('locationInfo');
        const currentLatSpan = document.getElementById('currentLat');
        const currentLngSpan = document.getElementById('currentLng');
        const lastUpdateSpan = document.getElementById('lastUpdate');
        const helpBtn = document.getElementById('helpBtn');
        const instructionsModal = document.getElementById('instructionsModal');
        const closeModal = document.getElementById('closeModal');

        // State variables
        let driverId = null;
        let watchId = null;
        let previewMap = null;
        let driverMarker = null;
        let isTracking = false;

        // Generate a unique driver ID (for demo purposes)
        function generateDriverId() {
            // Use session storage to persist ID across refreshes
            if (sessionStorage.getItem('buggyDriverId')) {
                return sessionStorage.getItem('buggyDriverId');
            }
            
            const id = 'driver_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('buggyDriverId', id);
            return id;
        }

        // Initialize driver ID
        driverId = generateDriverId();
        driverIdSpan.textContent = driverId;

        // Clean up Firebase entry on page load (in case previous session didn't clean up)
        window.addEventListener('load', function() {
            database.ref('buggies/' + driverId).remove().catch(() => {
                // Ignore errors if entry doesn't exist
            });
        });

        // Initialize preview map
        function initPreviewMap(lat, lng) {
            if (!previewMap) {
                previewMap = L.map('previewMap').setView([lat, lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(previewMap);
            }
            
            // Add or update marker
            if (!driverMarker) {
                driverMarker = L.marker([lat, lng], {
                    icon: L.icon({
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2258/2258965.png',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    })
                }).addTo(previewMap);
                driverMarker.bindPopup("<b>Your Location</b>").openPopup();
            } else {
                driverMarker.setLatLng([lat, lng]);
            }
            
            previewMap.setView([lat, lng], previewMap.getZoom());
        }

        // Update location to Firebase
        function updateLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const timestamp = Date.now();
            
            // Update display
            currentLatSpan.textContent = lat.toFixed(6);
            currentLngSpan.textContent = lng.toFixed(6);
            lastUpdateSpan.textContent = `Last updated: ${new Date(timestamp).toLocaleTimeString()}`;
            
            // Update map preview
            initPreviewMap(lat, lng);
            
            // Create buggy name from driver ID (e.g., "driver_abc123" becomes "Buggy abc")
            const buggyName = `Buggy ${driverId.replace('driver_', '').substr(0, 3)}`;
            
            // Save to Firebase with an "active" flag
            database.ref('buggies/' + driverId).set({
                lat: lat,
                lng: lng,
                timestamp: timestamp,
                name: buggyName,
                active: true
            }).catch(error => {
                console.error('Error saving location:', error);
            });
        }

        // Handle location errors
        function handleLocationError(error) {
            let message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location permission denied. Please enable location services.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable.';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out.';
                    break;
                default:
                    message = 'An unknown error occurred.';
                    break;
            }
            alert('Error: ' + message);
            stopTracking();
        }

        // Start tracking
        function startTracking() {
            if (watchId || isTracking) return;
            
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            
            startBtn.disabled = true;
            stopBtn.disabled = false;
            statusDiv.className = 'status status-active';
            statusDiv.textContent = 'Status: Tracking Active';
            locationInfoDiv.style.display = 'block';
            isTracking = true;
            
            // Start watching position
            watchId = navigator.geolocation.watchPosition(
                updateLocation,
                handleLocationError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 3000, // 3 seconds maximum age
                    timeout: 10000   // 10 second timeout
                }
            );
        }

        // Stop tracking and clean up Firebase
        function stopTracking() {
            if (!isTracking) return;
            
            isTracking = false;
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusDiv.className = 'status status-inactive';
            statusDiv.textContent = 'Status: Not Tracking';
            
            // Remove from Firebase
            database.ref('buggies/' + driverId).remove().catch(error => {
                console.error('Error removing from Firebase:', error);
            });
        }

        // Modal functions
        function openInstructions() {
            instructionsModal.style.display = 'flex';
        }

        function closeInstructions() {
            instructionsModal.style.display = 'none';
        }

        // Event Listeners
        startBtn.addEventListener('click', startTracking);
        stopBtn.addEventListener('click', stopTracking);
        helpBtn.addEventListener('click', openInstructions);
        closeModal.addEventListener('click', closeInstructions);

        // Close modal when clicking outside
        instructionsModal.addEventListener('click', (e) => {
            if (e.target === instructionsModal) {
                closeInstructions();
            }
        });

        // BEFORE UNLOAD - Clean up when user closes tab/navigates away
        window.addEventListener('beforeunload', function(event) {
            // Only clean up if we're actively tracking
            if (isTracking) {
                // We can't use async operations in beforeunload reliably
                // Use sendBeacon or synchronous AJAX for cleanup
                const data = JSON.stringify({
                    driverId: driverId,
                    action: 'cleanup'
                });
                
                // Try to send cleanup request
                navigator.sendBeacon('/api/cleanup', data);
                
                // Also try synchronous cleanup (less reliable but backup)
                try {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/api/cleanup', false); // Synchronous!
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(data);
                } catch (e) {
                    // Ignore errors in beforeunload
                }
                
                // Set a flag for pagehide to do cleanup
                sessionStorage.setItem('needsCleanup', driverId);
            }
        });

        // PAGEHIDE - Alternative to beforeunload (works better on mobile)
        window.addEventListener('pagehide', function() {
            if (isTracking) {
                stopTracking();
            }
        });

        // VISIBILITY CHANGE - Handle when user switches tabs
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isTracking) {
                // User switched tabs - we can pause updates or continue
                // For now, we'll continue tracking but could add pause/resume
            }
        });

        // Check if we need to clean up from a previous session
        window.addEventListener('load', function() {
            const needsCleanup = sessionStorage.getItem('needsCleanup');
            if (needsCleanup) {
                database.ref('buggies/' + needsCleanup).remove().catch(() => {
                    // Ignore errors
                });
                sessionStorage.removeItem('needsCleanup');
            }
        });
    </script>
</body>
</html>